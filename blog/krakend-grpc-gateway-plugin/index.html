<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>How to write a simple gRPC-gateway as a KrakenD plugin</title><meta name=description content="Step by step article on how to write a simple gRPC API gateway as a KrakenD plugin and expose it as a REST API."><meta itemprop=name content="How to write a simple gRPC-gateway as a KrakenD plugin"><meta itemprop=description content="Step by step article on how to write a simple gRPC API gateway as a KrakenD plugin and expose it as a REST API."><meta itemprop=image content="https://camo.githubusercontent.com/e75a8b46b078a3c1df0ed9966a16c24add9ccb83/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f3132687034435071724e5046686174744c5f63496f4a707446766c41716d35774c513067677149356d6b43672f7075623f773d37343926683d333730"><meta property="og:title" content="How to write a simple gRPC-gateway as a KrakenD plugin"><meta property="og:description" content="Step by step article on how to write a simple gRPC API gateway as a KrakenD plugin and expose it as a REST API."><meta property="og:type" content="article"><meta property="og:url" content="https://www.krakend.io/blog/krakend-grpc-gateway-plugin/"><meta property="og:image" content="https://camo.githubusercontent.com/e75a8b46b078a3c1df0ed9966a16c24add9ccb83/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f3132687034435071724e5046686174744c5f63496f4a707446766c41716d35774c513067677149356d6b43672f7075623f773d37343926683d333730"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-06-09T18:26:10+01:00"><meta property="article:modified_time" content="2019-06-09T18:26:10+01:00"><meta property="og:site_name" content="KrakenD - Open source API Gateway"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://camo.githubusercontent.com/e75a8b46b078a3c1df0ed9966a16c24add9ccb83/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f3132687034435071724e5046686174744c5f63496f4a707446766c41716d35774c513067677149356d6b43672f7075623f773d37343926683d333730"><meta name=twitter:title content="How to write a simple gRPC-gateway as a KrakenD plugin"><meta name=twitter:description content="Step by step article on how to write a simple gRPC API gateway as a KrakenD plugin and expose it as a REST API."><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name=viewport><link rel=stylesheet href="https://www.krakend.io/css/bundle.min.c422fb88ad479f0f24d8926d976eedb10ca07da30e38bfd2b7cbe7afdf15bfcf.css"><link rel=icon type=image/png href=/favicon/favicon-196x196.png sizes=196x196><link rel=icon type=image/png href=/favicon/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicon/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicon/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicon/favicon-128.png sizes=128x128><link href=https://www.googletagmanager.com rel=preconnect crossorigin><link rel=dns-prefetch href=https://www.googletagmanager.com><script>window.dataLayer=window.dataLayer||[],window.dataLayer.push({pagePublishDate:"2019-06-09",pageModifiedDate:"2019-06-09",pageReadingTimeMinutes:7,pageReadingTimeSeconds:371,pageWordCount:1361,pageFuzzyWordCount:1400,pageKind:"page",pageId:"f4215a49303d827c731d11c459a23140",pageTitle:"How to write a simple gRPC-gateway as a KrakenD plugin",pagePermalink:"https://www.krakend.io/blog/krakend-grpc-gateway-plugin/",pageType:"blog",pageTranslated:!1,pageAuthor:"Daniel López",pageCategory:"Tutorials \u0026 How-Tos",pageType2:"post",pageLanguage:"en"})</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="//www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-T8R6LF3")</script></head><body class=krakend><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-T8R6LF3" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><div class=print:hidden><p class="flex h-10 items-center justify-center bg-denim-500 px-4 text-sm font-medium text-white sm:px-6 lg:px-8"><a title="Upgrade to mitigate the Rapid Reset Attack vulnerability" href=https://www.krakend.io/blog/krakend-2.4.6-ce-2.4.2-ee-release-notes/ class="text-white text-bold"><span class="inline-flex items-center rounded-full bg-denim-100 px-2.5 py-0.5 mr-2 text-xs font-medium text-denim-800">News</span>
Upgrade to mitigate the Rapid Reset Attack vulnerability</a></p><div class=relative><nav class="max-w-7xl mx-auto lg:flex py-6 items-center justify-between"><div class="ml-4 xl:ml-0"><a href=/ title=Home><img src=/images/logo-krakend.svg alt="KrakenD Logo" loading=lazy width=180 height=34></a></div><div class="hidden ml-12 mr-4 xl:mr-0 lg:flex-grow lg:flex lg:justify-between lg:space-x-8" id=navbarMenu><ul class="lg:flex lg:space-x-8 font-medium xl:text-lg whitespace-nowrap z-50"><li><a class="hover:text-denim-600 text-gray-700" href=/open-source/>Open Source</a></li><li><a class="hover:text-denim-600 text-gray-700" href=/enterprise/>Enterprise</a></li><li><a class="hover:text-denim-600 text-gray-700" href=https://www.krakend.io/case-study/>Case studies</a></li><li><a class="hover:text-denim-600 text-gray-700" href=/docs/overview/>Docs</a></li><li class="nav-item dropdown"><a class="hover:text-denim-600 text-gray-700" href=# class="nav-link dropdown-toggle" data-toggle=dropdown>Resources<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></a><ul class="hidden absolute ml-4 divide-y rounded-lg shadow dropdown-menu bg-white"><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=/features/>Open Source VS Enterprise</a></li><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=/blog/>Blog</a></li><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=https://training.krakend.io/>Training & Certification</a></li><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=/support/>Support</a></li><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=https://designer.krakend.io>Designer (Config UI)</a></li><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=/partners/>Partners</a></li><li class="py-1 px-6"><a class="hover:text-denim-600 text-gray-700" href=/team/>About us</a></li></ul></li></ul><ul class="hidden lg:flex lg:space-x-4 text-sm font-medium whitespace-nowrap"><li><a class="text-gray-700 hover:text-denim-600" href=/download/><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414.0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414.0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>Downloads</a></li><li><a class="btn -mt-3 bg-denim-800 hover:bg-denim-500 text-white" href=/enterprise/#contact-sales><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>Request a Demo</a></li></ul></div><button class="print:hidden absolute right-4 top-2 lg:hidden p-3 rounded-lg border border-gray-100 navbar-toggler" type=button data-toggle=collapse data-target=#navbarMenu aria-controls=navbarMenu aria-expanded=false aria-label="Toggle navigation"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button></nav></div></div><div class=border-t><div class="grid grid-cols-1 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-x-8 py-6 max-w-7xl mx-auto"><div class="print:hidden order-last md:order-first col-span-2"><div class=px-4><h2 class="text-lg text-gray-500 pt-2">Blog categories</h2><ul class="px-6 py-5 space-y-3 text-sm font-medium whitespace-nowrap"><li class=nav-item><a class=nav-link href=/blog/>All categories</a></li></li><li><a href=https://www.krakend.io/categories/product-updates/>Product Updates</a> (43)</li><li><a href=https://www.krakend.io/categories/technical-insights-best-practices/>Technical Insights & Best practices</a> (18)</li><li><a href=https://www.krakend.io/categories/company-announcements/>Company Announcements</a> (12)</li><li><a href=https://www.krakend.io/categories/tutorials-how-tos/>Tutorials & How-Tos</a> (10)</li><li><a href=https://www.krakend.io/categories/security/>Security</a> (6)</li></ul></div><div class="px-4 mt-8"><h2 class="text-lg text-gray-500 pt-8 border-t">Recent entries</h2><ul class="px-6 py-5 space-y-3 text-sm font-medium"><li class=nav-item><a class=nav-link href=https://www.krakend.io/blog/krakend-2.4.6-ce-2.4.2-ee-release-notes/>Upgrade to mitigate the Rapid Reset Attack vulnerability</a></li><li class=nav-item><a class=nav-link href=https://www.krakend.io/blog/krakend-api-gateway-training-certification/>KrakenD Training: The Definitive Certification Program for API Gateway Mastery</a></li><li class=nav-item><a class=nav-link href=https://www.krakend.io/blog/openapi-krakend-enterprise/>Unlocking the Power of OpenAPI with KrakenD Enterprise</a></li><li class=nav-item><a class=nav-link href=https://www.krakend.io/blog/api-rate-limit/>Mastering API Rate Limiting with KrakenD: A Comprehensive Guide</a></li><li class=nav-item><a class=nav-link href=https://www.krakend.io/blog/generating-a-sbom/>Automating the Software Bill of Materials (SBOM)</a></li></ul></div></div><div class="col-span-3 lg:col-span-4 xl:col-span-5 max-w-full text-lg"><section class=px-4><article class=mb-24><header class="mb-6 lg:mb-12"><h1 class="text-denim-800 text-current text-3xl md:text-5xl"><a class=text-current href=https://www.krakend.io/blog/krakend-grpc-gateway-plugin/>How to write a simple gRPC-gateway as a KrakenD plugin</a></h1><div class="my-4 md:flex items-center gap-x-4"><p class=text-denim-800>by <strong>Daniel López</strong></p><p><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline -mt-1 text-gray-500" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M6 2A1 1 0 005 3v1H4A2 2 0 002 6v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3A1 1 0 006 2zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>Jun 9, 2019</p><div class="text-sm text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline text-gray-500 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>7 min read</div></div><img src=https://camo.githubusercontent.com/e75a8b46b078a3c1df0ed9966a16c24add9ccb83/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f3132687034435071724e5046686174744c5f63496f4a707446766c41716d35774c513067677149356d6b43672f7075623f773d37343926683d333730 alt="post image" loading=lazy class="post-image img-fluid"></header><div class="prose prose max-w-full text-lg"><p><em>image from the official <a href=https://github.com/grpc-ecosystem/grpc-gateway>grpc-gateway repository</a></em></p><div class="rounded-lg p-4 bg-gradient-to-br from-indigo-100 to-indigo-50 border border-indigo-100 overflow-auto"><div class="mb-2 font-bold text-indigo-700"><svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-6 w-6 inline" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12A9 9 0 113 12a9 9 0 0118 0z"/></svg>KrakenD Enterprise has native gRPC capabilities since v2.3</div><div class="text-base text-gray-600 my-2">If you are a user of KrakenD Enterprise, <strong>you don&rsquo;t need to code any plugin</strong>. See <a href=/docs/enterprise/backends/grpc/>Enterprise gRPC</a>.</div></div><p>The gRPC protocol is becoming trendy in the era of microservices. Its compactness and backward compatibility make it very attractive. However, it requires custom code to work with it. In this article, we&rsquo;ll show you how to get all the benefits from the gRPC protocol and the gRPC-gateway without coding any business logic to use your gRPC services as regular backends, moreover avoiding the extra network hop!</p><p>This article begins with an introduction to gRPC services and how to build some demos using the available definitions. If you are already familiar with gRPC and have created a grpc-gateway, you can skip the first sections and jump directly to <a href=#finishing-the-grpc-gateway>Finishing the gRPC-gateway</a></p><p><strong>Disclaimer</strong>: this is not a gRPC intro. If you need to learn about it, consider reading the <a href=https://grpc-ecosystem.github.io/grpc-gateway/>project site</a> before going further.</p><h2 id=grpc-backends-and-gateway>gRPC backends and gateway</h2><h3 id=service-definitions>Service definitions</h3><p>We&rsquo;ll use two examples of the gRPC project: <code>helloworld</code> and <code>routeguide</code>. So we can start by adding their definitions to the <code>protos</code> folder.</p><p>Since we want to consume these services using JSON, we must create the proper definitions (or annotations) to generate the gRPC-gateway code. Check the <a href=https://cloud.google.com/endpoints/docs/grpc-service-config/reference/rpc/google.api#httprule>documentation</a> for more details.</p><p><code>helloworld.yml</code></p><pre tabindex=0><code> type: google.api.Service
 config_version: 3

 http:
   rules:
   - selector: helloworld.Greeter.SayHello
     get: /v1/helloworld/hello/{name}
</code></pre><p><code>routeguide.yml</code></p><pre tabindex=0><code> type: google.api.Service
 config_version: 3

 http:
   rules:
   - selector: routeguide.RouteGuide.GetFeature
     get: /v1/routeguide/features/{latitude}/{longitude}
   - selector: routeguide.RouteGuide.ListFeatures
     get: /v1/routeguide/features/{lo.latitude}/{lo.longitude}/{hi.latitude}/{hi.longitude}
   - selector: routeguide.RouteGuide.RecordRoute
     post: /v1/routeguide/route
     body: &#34;*&#34;
</code></pre><p>These are the contents of the <code>protos</code> folder:</p><pre tabindex=0><code>protos
├── helloworld.proto
├── helloworld.yml
├── routeguide.proto
└── routeguide.yml
</code></pre><h3 id=generating-the-code>Generating the code</h3><p>As described in the <a href=https://grpc-ecosystem.github.io/grpc-gateway/docs/grpcapiconfiguration.html>project documentation</a>, we&rsquo;ll need to follow some simple steps:</p><ul><li>generate the grpc bindings</li><li>generate the grpc-gateway bindings</li><li>generate the swagger definitions</li></ul><p>We can do it with a simple bash script:</p><pre tabindex=0><code>#!/bin/bash

for i in &#34;$@&#34;
do :
  echo &#34;generating ${i} service&#34;

  echo &#34;  - grpc bindings&#34;
  protoc -I/usr/local/include -I. \
    -I$GOPATH/src \
    -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
    --go_out=plugins=grpc:. \
    protos/${i}.proto

  echo &#34;  - grpc-gateway&#34;
  protoc -I/usr/local/include -I. \
    -I$GOPATH/src \
    -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
    --grpc-gateway_out=logtostderr=true,grpc_api_configuration=protos/${i}.yml:. \
    protos/${i}.proto

  # move generated sources
  mkdir -p generated/${i}
  mv protos/${i}.*.go generated/${i}/.

  echo &#34;  - grpc-gateway swagger&#34;
  protoc -I/usr/local/include -I. \
    -I$GOPATH/src \
    -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
    --swagger_out=logtostderr=true,grpc_api_configuration=protos/${i}.yml:. \
    protos/${i}.proto
done

echo &#34;generating static files&#34;
# move and pack the swagger definitions
mkdir -p protos/swagger
mv protos/*.swagger.json protos/swagger/.

[ ! -d statik ] || rm -rf statik
[ ! -d gateway/statik ] || rm -rf gateway/statik
go get github.com/rakyll/statik
go install github.com/rakyll/statik
statik -src=protos/swagger
mv statik gateway/.
rm -rf protos/swagger

echo &#34;services generated&#34;
</code></pre><p>and invoke it with <code>sh generate.sh helloworld routeguide</code></p><p>The <code>generate.sh</code> will also create a package with the swagger definitions, so no static files should be attached to the final binary.</p><h3 id=finishing-the-backend-grpc-services>Finishing the backend gRPC services</h3><p>The already generated code requires a main function and the implementation of every service interface. We can use some available example implementations or go with our custom ones.</p><p>Examples:</p><ul><li><a href=https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go>https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go</a></li><li><a href=https://github.com/grpc/grpc-go/blob/master/examples/route_guide/server/server.go>https://github.com/grpc/grpc-go/blob/master/examples/route_guide/server/server.go</a></li></ul><p>Custom:</p><ul><li><a href=https://github.com/kpacha/krakend-grpc-gateway-post/blob/master/cmd/helloworld/main.go>https://github.com/kpacha/krakend-grpc-gateway-post/blob/master/cmd/helloworld/main.go</a></li><li><a href=https://github.com/kpacha/krakend-grpc-gateway-post/blob/master/cmd/routeguide/main.go>https://github.com/kpacha/krakend-grpc-gateway-post/blob/master/cmd/routeguide/main.go</a></li></ul><h2 id=finishing-the-grpc-gateway>Finishing the gRPC-gateway</h2><p>To get your grpc-gateway up and running, we&rsquo;ll need two essential things:</p><ul><li>Create the gateway http.Handler</li><li>Create and start the server using that handler</li></ul><p><em>We are splitting this into two steps so we will be able to play with plugins in the future</em></p><h3 id=create-the-gateway-httphandler>Create the gateway http.Handler</h3><p>Time to use the auto-generated register functions and add the swagger file server. We need to create the <code>http.Handler</code> that will be injected into a custom <code>http.Server</code>, so add a file called <code>gateway/gateway.go</code> with the following content:</p><pre tabindex=0><code>package gateway

import (
    &#34;context&#34;
    &#34;net/http&#34;

    &#34;github.com/grpc-ecosystem/grpc-gateway/runtime&#34;
    &#34;github.com/rakyll/statik/fs&#34;
    &#34;google.golang.org/grpc&#34;

    _ &#34;github.com/kpacha/krakend-grpc-post/gateway/statik&#34;
    &#34;github.com/kpacha/krakend-grpc-post/generated/helloworld&#34;
    &#34;github.com/kpacha/krakend-grpc-post/generated/routeguide&#34;
)

func New(ctx context.Context, helloEndpoint, routeEndpoint string) (http.Handler, error) {
    gw := runtime.NewServeMux()
    opts := []grpc.DialOption{grpc.WithInsecure()}

    if err := helloworld.RegisterGreeterHandlerFromEndpoint(ctx, gw, helloEndpoint, opts); err != nil {
        return nil, err
    }

    if err := routeguide.RegisterRouteGuideHandlerFromEndpoint(ctx, gw, routeEndpoint, opts); err != nil {
        return nil, err
    }

    statikFS, err := fs.New()
    if err != nil {
        return nil, err
    }
    mux := http.NewServeMux()
    mux.Handle(&#34;/swagger/&#34;, http.StripPrefix(&#34;/swagger/&#34;, http.FileServer(statikFS)))
    mux.Handle(&#34;/&#34;, gw)

    return mux, nil
}
</code></pre><h3 id=create-the-gateway-server>Create the gateway server</h3><p>The server can be created and managed from the main package itself. It needs to call the already created <code>gateway.New</code> function and define the port and the shutdown strategy:</p><pre tabindex=0><code>package main

import (
    &#34;context&#34;
    &#34;flag&#34;
    &#34;fmt&#34;
    &#34;log&#34;
    &#34;net/http&#34;

    &#34;github.com/kpacha/krakend-grpc-post/gateway&#34;
)

var (
    helloworldEndpoint = flag.String(&#34;hello_endpoint&#34;, &#34;localhost:50051&#34;, &#34;endpoint of GreeterServer&#34;)
    routeguideEndpoint = flag.String(&#34;route_endpoint&#34;, &#34;localhost:50052&#34;, &#34;endpoint of RouteGuideServer&#34;)
    port               = flag.Int(&#34;p&#34;, 8080, &#34;port of the service&#34;)
)

func main() {
    flag.Parse()

    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()

    mux, err := gateway.New(ctx, *helloworldEndpoint, *routeguideEndpoint)
    if err != nil {
        log.Printf(&#34;Setting up the gateway: %s&#34;, err.Error())
        return
    }

    srvAddr := fmt.Sprintf(&#34;:%d&#34;, *port)

    s := &amp;http.Server{
        Addr:    srvAddr,
        Handler: mux,
    }

    go func() {
        &lt;-ctx.Done()
        log.Printf(&#34;Shutting down the http server&#34;)
        if err := s.Shutdown(context.Background()); err != nil {
            log.Printf(&#34;Failed to shutdown http server: %v&#34;, err)
        }
    }()

    log.Printf(&#34;Starting listening at %s&#34;, srvAddr)
    if err := s.ListenAndServe(); err != http.ErrServerClosed {
        log.Printf(&#34;Failed to listen and serve: %v&#34;, err)
    }
}
</code></pre><h2 id=build-and-start-everything>Build and start everything</h2><p>Just compile the binaries and start them</p><pre tabindex=0><code>go build ./cmd/grpc-gateway
go build ./cmd/helloworld
go build ./cmd/routeguide

./routeguide &amp;
./helloworld &amp;
./grpc-gateway &amp;
</code></pre><p>Now we are ready to test our grpc-gateway!</p><pre tabindex=0><code>$ curl -i &#34;http://localhost:8080/v1/routeguide/features/407838350/-746143763/407838353/-74614373&#34;
HTTP/1.1 200 OK
Content-Type: application/json
Grpc-Metadata-Content-Type: application/grpc
Date: Wed, 08 May 2019 15:49:07 GMT
Transfer-Encoding: chunked

{&#34;result&#34;:{&#34;name&#34;:&#34;Patriots Path, Mendham, NJ 07945, USA&#34;,&#34;location&#34;:{&#34;latitude&#34;:407838351,&#34;longitude&#34;:-746143763}}}
</code></pre><h2 id=krakend-plugins>KrakenD plugins</h2><p>Using the new branch <a href=https://github.com/krakend/krakend-ce/tree/modules>modules</a>, it is straightforward to create customized request executors and inject them as plugins into the KrakenD-CE binary. If we want to avoid the network hop between the KrakenD gateway and the grpc-gateway, we can inject the latter into the former as a plugin with just this code:</p><pre tabindex=0><code>package main

import (
    &#34;context&#34;
    &#34;errors&#34;
    &#34;fmt&#34;
    &#34;net/http&#34;

    &#34;github.com/kpacha/krakend-grpc-post/gateway&#34;
)

func init() {
    fmt.Println(&#34;krakend-grpc-post plugin loaded!!!&#34;)
}

var GRPCRegisterer = registerer(&#34;grpc-post&#34;)

type registerer string

func (r registerer) RegisterClients(f func(
    name string,
    handler func(context.Context, map[string]interface{}) (http.Handler, error),
)) {
    f(string(r), func(ctx context.Context, extra map[string]interface{}) (http.Handler, error) {
        cfg := parse(extra)
        if cfg == nil {
            return nil, errors.New(&#34;wrong config&#34;)
        }
        if cfg.name != string(r) {
            return nil, fmt.Errorf(&#34;unknown register %s&#34;, cfg.name)
        }
        return gateway.New(ctx, cfg.helloEndpoint, cfg.routeEndpoint)
    })
}

... // aux function &#39;parse&#39; omitted
</code></pre><p>Also, compile our grpc-gateway as a golang plugin</p><pre tabindex=0><code>go build -buildmode=plugin -o grpc-gateway-post.so ./plugin
</code></pre><p>With the plugin already built, we can add the required configuration to our API gateway and expose a single endpoint consuming the endpoints offered by the grpc-gateway as backends without an extra network hop between the KrakenD API gateway and the gRPC-gateway</p><pre tabindex=0><code>{
    &#34;version&#34;: 2,
    &#34;name&#34;: &#34;My lovely gateway&#34;,
    &#34;port&#34;: 8000,
    &#34;cache_ttl&#34;: &#34;3600s&#34;,
    &#34;timeout&#34;: &#34;3s&#34;,
    &#34;plugin&#34;: {
        &#34;pattern&#34;:&#34;.so&#34;,
        &#34;folder&#34;: &#34;./plugin/&#34;
    },
    &#34;extra_config&#34;: {
      &#34;github_com/devopsfaith/krakend-gologging&#34;: {
        &#34;level&#34;:  &#34;DEBUG&#34;,
        &#34;prefix&#34;: &#34;[KRAKEND]&#34;,
        &#34;syslog&#34;: false,
        &#34;stdout&#34;: true
      },
    },
    &#34;endpoints&#34;: [
        {
            &#34;endpoint&#34;: &#34;/user/{name}/{latitude}/{longitude}&#34;,
            &#34;backend&#34;: [
                {
                    &#34;host&#34;: [ &#34;http://ignore.this&#34; ],
                    &#34;url_pattern&#34;: &#34;/v1/helloworld/hello/{name}&#34;,
                    &#34;extra_config&#34;: {
                        &#34;github.com/devopsfaith/krakend/transport/http/client/executor&#34;: {
                            &#34;name&#34;: &#34;grpc-post&#34;,
                            &#34;endpoints&#34;: [ &#34;localhost:50051&#34;, &#34;localhost:50052&#34; ]
                        }
                    }
                },
                {
                    &#34;host&#34;: [ &#34;http://ignore.this&#34; ],
                    &#34;url_pattern&#34;: &#34;/v1/routeguide/features/{latitude}/{longitude}&#34;,
                    &#34;group&#34;: &#34;feature&#34;,
                    &#34;extra_config&#34;: {
                        &#34;github.com/devopsfaith/krakend/transport/http/client/executor&#34;: {
                            &#34;name&#34;: &#34;grpc-post&#34;,
                            &#34;endpoints&#34;: [ &#34;localhost:50051&#34;, &#34;localhost:50052&#34; ]
                        }
                    }
                }
            ]
        },
    ]
}
</code></pre><p>Our log message should be displayed at the booting stage.</p><pre tabindex=0><code>$ ./krakend run -d -c krakend.json
Parsing configuration file: krakend.json
...
[KRAKEND] 2019/05/08 - 20:47:28.079 ▶ INFO Listening on port: 8000
...
krakend-grpc-post plugin loaded!!!
[KRAKEND] 2019/05/08 - 20:47:28.107 ▶ INFO plugins loaded: 1
...
</code></pre><p>Time to test our new endpoint!</p><pre tabindex=0><code>$ curl -i localhost:8000/user/foo/407838351/-746143763
HTTP/1.1 200 OK
Cache-Control: public, max-age=3600
Content-Type: application/json; charset=utf-8
X-Krakend: Version 0.9.0
X-Krakend-Completed: true
Date: Wed, 08 May 2019 18:48:48 GMT
Content-Length: 139

{&#34;feature&#34;:{&#34;location&#34;:{&#34;latitude&#34;:407838351,&#34;longitude&#34;:-746143763},&#34;name&#34;:&#34;Patriots Path, Mendham, NJ 07945, USA&#34;},&#34;message&#34;:&#34;Hello foo&#34;}
</code></pre><p>It works!</p><p>Here, the <a href=https://github.com/kpacha/krakend-grpc-gateway-post>code for this post</a></p><h2 id=summary>Summary</h2><p>In this article, we shared our explorations in the golang plugins area. We&rsquo;ve split the custom code required for building our gRPC-gateway into separated components for later reuse of one of them. Then, introducing just a few lines of code, we&rsquo;ve shown how to integrate any golang component exposing an <code>http.Handler</code> into the KrakenD-CE as a backend.</p><p>Did you make it this far? Do you have questions or comments? Consider joining now our #krakend channel at <a href=https://invite.slack.golangbridge.org/>Gophers</a> on Slack.</p><p>Thanks for reading! If you like our product, don&rsquo;t forget to <a href=https://github.com/luraproject/lura/stargazers>star our project</a>!</p><p>Enjoy KrakenD!</p><div class="border-t border-gray-200"><p class=text-sm><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline text-gray-500" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414.0l-7-7A.997.997.0 012 10V5a3 3 0 013-3h5c.256.0.512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>Categories:
<a href=/categories/tutorials-how-tos/ title="More posts about Tutorials & How-Tos"><span class="inline-flex items-center rounded-full bg-denim-100 px-2.5 py-0.5 mr-2 text-xs font-medium text-denim-800">Tutorials & How-Tos</span></a></p></div></div></article></section></div></div></div><div class="print:hidden bg-gradient-to-r from-denim-500 to-denim-800 py-8"><div class="max-w-7xl mx-auto sm:flex sm:space-y-0 space-y-4 text-center sm:text-left items-center justify-between px-8"><div class="flex-none text-xl font-medium text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 20 20" fill="currentcolor"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0016 4H4A2 2 0 002.003 5.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>&nbsp;Stay up to date with KrakenD releases and important updates</div><div class=flex-grow><form action="https://krakend.us19.list-manage.com/subscribe/post?u=5cae4bbe9877b1adfe8fe808d&amp;id=e5385eb57b&amp;v_id=4265&amp;f_id=006687e4f0" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_5cae4bbe9877b1adfe8fe808d_e5385eb57b tabindex=-1></div><div class="flex items-center justify-center sm:justify-end"><input type=email name=EMAIL class="block rounded-l px-3 py-1 w-full max-w-xs" id=mce-EMAIL placeholder="email address" required>
<input type=hidden name=tags value=6244009>
<input type=hidden id=gdpr_14365 name=gdpr[14365] value=Y>
<input type=submit class="block bg-denim-500 text-white rounded-r px-3 py-1" value=Subscribe></div></form></div></div></div><footer class="print:hidden bg-gradient-to-r from-denim-900 to-denim-800 py-8 sm:py-18 text-gray-300"><div class="max-w-7xl mx-auto px-4"><div class="lg:grid lg:grid-cols-6 md:grid md:grid-cols-4"><div class="lg:col-span-3 pr-12"><img src=/images/logo-white.png alt="KrakenD API Gateway" loading=lazy width=353 height=70><p class="text-xl my-6 text-denim-300">The <strong>Ultra-High performance</strong> Open Source API Gateway</p><p class="text-sm my-4">KrakenD helps application developers release features quickly by eliminating all the complexities of SOA architectures while offering a unique performance.</p></div><div><h6>Social</h6><ul class="ml-2 my-2"><li><a class=text-denim-300 href=/blog/>Blog</a></li><li><a class=text-denim-300 href=https://medium.com/krakend>Medium</a></li><li><a class=text-denim-300 href=https://twitter.com/krakend_io>Twitter</a></li><li><a class=text-denim-300 href=https://github.com/krakend/>GitHub</a></li><li><a class=text-denim-300 href=https://www.linkedin.com/company/krakend/>LinkedIn</a></li></ul><h6>Experiments</h6><ul class="ml-2 mb-2"><li><a class=text-denim-300 href=https://api2html.com>API2HTML</a></li></ul></div><div><h6>KrakenD</h6><ul class="ml-2 my-2"><li><a class=text-denim-300 href=/open-source/>Open Source</a></li><li><a class=text-denim-300 href=/enterprise/>Enterprise</a></li><li><a class=text-denim-300 href=/case-study/>Case studies</a></li><li><a class=text-denim-300 href=/docs/benchmarks/>Benchmarks</a></li><li><a class=text-denim-300 href=/download/>Download</a></li><li><a class=text-denim-300 href=/team/>Team</a></li></ul></div><div><h6>Support</h6><ul class="ml-2 my-2"><li><a class=text-denim-300 href=/support/>Support channels</a></li><li><a class=text-denim-300 href=https://training.krakend.io/>Training & Certification</a></li><li><a class=text-denim-300 href=/docs/overview/>Documentation</a></li><li><a class=text-denim-300 href=https://github.com/krakend/krakend-ce target=_blank>Open Source</a></li><li><a class=text-denim-300 href=https://github.com/krakend/krakend-ce/issues>Report an issue</a></li><li><a class=text-denim-300 href=https://www.krakend.io/security-policy/>Report a vulnerability</a></li></ul></div></div><div class="sm:flex sm:justify-between sm:items:center"><div><strong>Copyright &copy; 2017-2023 KRAKEND S.L.</strong> - <a href=/terms/ class=text-denim-300>Terms</a> - <a href=/privacy-policy/ class=text-denim-300>Privacy Policy</a></div><div class=whitespace-nowrap>Made with&nbsp;
<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline text-red-600 animate-pulse" viewBox="0 0 20 20" fill="currentcolor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656.0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>&nbsp;in Barcelona</div></div></div></footer><div class="print:hidden fixed w-full text-sm bottom-0 bg-white border-t border-gray-400 pea_cook_wrapper pea_cook_bottom z-20"><p class="relative max-w-7xl mx-auto py-4">We use cookies to understand how you use our site and to improve your overall experience. By continuing to use our site, you accept our Privacy Policy.
<a data-toggle=modal data-target=#cookiesConsent class=text-black href=#>More information</a>
<button class="absolute right-0 top-2 p-2 bg-denim-500 rounded-lg text-white ACCEPT_COOKIES">Accept</button></p></div><div class="hidden fixed top-0 left-0 w-full h-full bg-denim-800 bg-opacity-80" id=cookiesConsent tabindex=-1 role=dialog aria-labelledby=cookiesConsentLabel aria-hidden=true><div class="modal-dialog mx-auto top-1/3 max-w-xl bg-white rounded-lg p-12 relative" role=document><div class=modal-content><div class=mb-4><h5 class=font-bold id=cookiesConsentLabel>Cookies</h5><button type=button class="close absolute right-5 top-5 text-xl" data-dismiss=modal aria-label=Close>
<span aria-hidden=true>✖︎</span></button></div><div class=text-sm><p>In order to give you the best experience, we use cookies and similar technologies for performance, analytics and marketing. Want to know more? <a href=/privacy-policy/>Privacy Policy</a></p></div><div class="mt-4 text-center"><button type=button class="py-1 px-3 bg-denim-500 text-white rounded-lg ACCEPT_COOKIES" data-dismiss=modal>
Accept cookies</button></div></div></div></div><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script>
<script src=https://www.krakend.io/main.js></script>
<script>(function(e,t,n,s,o,i){o="",s="https://tracking.g2crowd.com/attribution_tracking/conversions/"+e+".js?p="+encodeURI(t)+"&e="+o,i=document.createElement("script"),i.type="application/javascript",i.async=!0,i.src=s,n.getElementsByTagName("head")[0].appendChild(i)})("1007316",document.location.href,document)</script></body></html>